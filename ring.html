<!DOCTYPE html>
<html>
<head>
<title>Fabelier Doorbell</title>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>

<img src="{{logo_url}}" style="float: left; padding-right: 50px" alt="logo"><br/>
<div id=content>
<h1>Fabelier door bell</h1>
Please, ring here ...and wait, please :)<br/>
<br/>
<input id=bell type=button value="The bell" style="height: 100px; width: 200px;" >
<input id="state" type="text" value=""><br/>

{{#password}}
Password: <input id="password" type="password"/><br/>
{{/password}}

</div>

<script>

StateEnum = {
  EMPTY: 0,
  RINGING: 1,
  INVALID_PASSWORD: 2,
  COMING: 3
}

window.onload = function() {

    var messages = [];
    var currentState = StateEnum.EMPTY;
    var socket = io.connect('{{url}}');
    var bellButton = document.getElementById("bell");
    var state = document.getElementById("state");
    var currentlyRinging = false;
    var password = document.getElementById("password");

    //Register as a visitor
    socket.emit('type', {type: 'visitor'});

    bellButton.onclick = function() {
        resetStateField();
        socket.emit('ring', { password: password.value });
    };

    socket.on('message', function(data) {
        if(data.message) {
          currentState = StateEnum.COMING;
          state.value = data.message;
        } else {
          console.log("There is a problem: ", data);
        }
    });

    socket.on('bad_password', function(data) {
        current_state = StateEnum.INVALID_PASSWORD;
        state.value = "Invalid password";
    });

    socket.on('ringing', function(data) {
        currentState = StateEnum.RINGING;
        state.value = "Ringing";
        setTimeout(resetStateField, 10000);
    });

    function resetStateField(){
      if ( currentState != StateEnum.COMING ){
        currentState = StateEnum.EMPTY;
        state.value = "";
      }
    }
}

</script>
</body>
</html>
